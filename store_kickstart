#!/bin/bash

# Function to handle errors and exit the script
handle_error() {
    echo "âŒ Error occurred in script at line: $1"
    echo "â„¹ï¸ Error message: $2"
    exit 1
}

# Trap errors and call the handle_error function
trap 'handle_error $LINENO "$BASH_COMMAND"' ERR

# Download store from the internet
echo "ğŸŒ Downloading store from the internet..."
wget -P ~/ceremonyclient/node/.config https://snapshots.cherryservers.com/quilibrium/store.zip
echo "âœ… Download completed successfully."
sleep 1

# Stop node service
echo "ğŸ›‘ Stopping node service..."
service ceremonyclient stop
echo "âœ… Node service stopped successfully."
sleep 1

# Rename store to store-original
echo "ğŸ”„ Renaming store to store-original..."
mv ~/ceremonyclient/node/.config/store ~/ceremonyclient/node/.config/store-original
echo "âœ… Store renamed successfully."
sleep 1

# Extract archive in store folder without showing output
echo "ğŸ“¦ Extracting archive in store folder..."
cd ~/ceremonyclient/node/.config
unzip store.zip -d store > /dev/null
echo "âœ… Archive extracted successfully."

# Delete store.zip file
echo "ğŸ—‘ï¸ Deleting store.zip file..."
rm ~/ceremonyclient/node/.config/store.zip
echo "âœ… store.zip deleted successfully."
sleep 3

# Restart node service
echo "ğŸ”„ Restarting node service..."
service ceremonyclient start
echo "âœ… Node service started successfully."

echo -e "\nğŸ“œ I will now show the node log (CTRL+C to detach)"
echo "ğŸ’¡ Remember to manually remove the store-original (backup of your original store folder) if everything went well."

# Show node log
sudo journalctl -u ceremonyclient.service -f --no-hostname -o cat
