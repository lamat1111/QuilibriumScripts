#!/bin/bash

# Step 0: Welcome
echo "âœ¨ Welcome! This script will changed your Qnode store folder with another one for fast syncing. âœ¨"
echo "You must be running the node as a service, otherwise the script won't work"
echo "If you are not running as a service, follow the step by step process at https://iri.quest/qnode-store" 
echo "Made with ğŸ”¥ by LaMat"
echo ""
echo "Processing... â³"
sleep 7  # Add a 7-second delay

# Check if ceremonyclient service exists
if ! systemctl list-unit-files | grep -q 'ceremonyclient.service'; then
    echo "âŒ The 'ceremonyclient' service does not exist."
    echo "Please make sure you are running the node as a service."
    echo "If you are not running as a service, follow the step-by-step process at https://iri.quest/qnode-store"
    exit 1
fi

# Check if zip and unzip are installed
if ! command -v zip &> /dev/null; then
    echo "ğŸš¨ Zip utility is not installed. Installing..."
    sudo apt-get update && sudo apt-get install -y zip || handle_error $LINENO "Failed to install zip utility."
    echo "âœ… Zip utility installed successfully."
fi

if ! command -v unzip &> /dev/null; then
    echo "ğŸš¨ Unzip utility is not installed. Installing..."
    sudo apt-get update && sudo apt-get install -y unzip || handle_error $LINENO "Failed to install unzip utility."
    echo "âœ… Unzip utility installed successfully."
fi

# Function to handle errors and exit the script
handle_error() {
    echo "âŒ Error occurred in script at line: $1"
    echo "â„¹ï¸ Error message: $2"
    exit 1
}

# Trap errors and call the handle_error function
trap 'handle_error $LINENO "$BASH_COMMAND"' ERR

# Check if store.zip already exists and overwrite if it does
if [ -f ~/ceremonyclient/node/.config/store.zip ]; then
    echo "âš ï¸ store.zip already exists. Overwriting..."
    rm ~/ceremonyclient/node/.config/store.zip
    echo "âœ… Previous store.zip deleted successfully."
fi

# Download store from the internet
echo "ğŸŒ Downloading store from the internet..."
wget -P ~/ceremonyclient/node/.config https://snapshots.cherryservers.com/quilibrium/store.zip
echo "âœ… Download completed successfully."
sleep 1

# Stop node service if it's not already stopped
if systemctl is-active --quiet ceremonyclient; then
    echo "ğŸ›‘ Stopping node service..."
    sudo service ceremonyclient stop
    echo "âœ… Node service stopped successfully."
else
    echo "ğŸŸ¢ Node service is already stopped. Moving on..."
fi
sleep 1

# Rename store to store-original
echo "ğŸ”„ Renaming store to store-original..."
mv ~/ceremonyclient/node/.config/store ~/ceremonyclient/node/.config/store-original
echo "âœ… Store renamed successfully."
sleep 1

# Extract archive in store folder without showing output
echo "ğŸ“¦ Extracting archive in store folder..."
cd ~/ceremonyclient/node/.config
unzip store.zip -d . > /dev/null
# unzip store.zip -d store > /dev/null - this creates a nested store/store folder
echo "âœ… Archive extracted successfully."

# Delete store.zip and store-original
echo "ğŸ—‘ï¸ Deleting store.zip and store-original..."
rm ~/ceremonyclient/node/.config/store.zip
echo "âœ… store.zip deleted successfully."
rm ~/ceremonyclient/node/.config/store-original
echo "âœ… store-original deleted successfully."
sleep 3

# Restart node service
echo "ğŸ”„ Restarting node service..."
service ceremonyclient start
echo "âœ… Node service started successfully."

echo -e "\nğŸ“œ I will now show the node log (CTRL+C to detach)"
echo ""
echo ""

# Show node log
sudo journalctl -u ceremonyclient.service -f --no-hostname -o cat
