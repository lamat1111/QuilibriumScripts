#!/bin/bash

# Exit on any error
set -e

# Step 1: Define a function for displaying exit messages
exit_message() {
    echo "âŒ Oops! There was an error during the script execution and the process stopped. No worries!"
    echo "ðŸ”„ You can try to run the script from scratch again."
    echo "ðŸ› ï¸ If you still receive an error, you may want to proceed manually, step by step instead of using the auto-installer."
}

# Step 2: Set a trap to call exit_message on any error
trap exit_message ERR

# Step 3: Welcome
echo "âœ¨ This script will install your Quilibrium node as a service and start it. âœ¨"
echo "Made with â¤ï¸ by  0xOzgur.eth (edited by LaMat)"
echo "Processing... â³"
sleep 7  # Add a 7-second delay

# Step 4:Download Ceremonyclient
echo "â³ Downloading Ceremonyclient"
sleep 1  # Add a 1-second delay
cd ~
git clone https://github.com/QuilibriumNetwork/ceremonyclient.git
git checkout release

# Step 5: Build Ceremonyclient qClient
echo "â³ Building qCiient"
sleep 1  # Add a 1-second delay
cd ~/ceremonyclient/client
GOEXPERIMENT=arenas go build -o qclient main.go

# Get the system architecture
ARCH=$(uname -m)

# Step 6:Determine the ExecStart line based on the architecture
if [ "$ARCH" = "x86_64" ]; then
    EXEC_START="/root/ceremonyclient/node/node-1.4.18-linux-amd64"
elif [ "$ARCH" = "aarch64" ]; then
    EXEC_START="/root/ceremonyclient/node/node-1.4.18-linux-arm64"
elif [ "$ARCH" = "arm64" ]; then
    EXEC_START="/root/ceremonyclient/node/node-1.4.18-darwin-arm64"
else
    echo "Unsupported architecture: $ARCH"
    exit 1
fi

# Step 7:Create Ceremonyclient Service
echo "â³ Re-Creating Ceremonyclient Service"
sleep 2  # Add a 2-second delay
rm /lib/systemd/system/ceremonyclient.service
sudo tee /lib/systemd/system/ceremonyclient.service > /dev/null <<EOF
[Unit]
Description=Ceremony Client Go App Service

[Service]
Type=simple
Restart=always
RestartSec=5s
WorkingDirectory=/root/ceremonyclient/node
ExecStart=$EXEC_START

[Install]
WantedBy=multi-user.target
EOF

# Step 8: Updating the node to v1.4.18
echo "â³ Updating the node to v1.4.18"
wget -O - https://raw.githubusercontent.com/0xOzgur/QuilibriumTools/v1.4.18/update.sh | bash
