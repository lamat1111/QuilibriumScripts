#!/bin/bash

# Exit on any error
set -e

# Step 1: Define a function for displaying exit messages
exit_message() {
    echo "âŒ Oops! There was an error during the script execution and the process stopped. No worries!"
    echo "ðŸ”„ You can try to run the script from scratch again."
    echo "ðŸ› ï¸ If you still receive an error, you may want to proceed manually, step by step instead of using the auto-installer."
}

# Step 2: Set a trap to call exit_message on any error
trap exit_message ERR

# Step 3: Welcome
echo "âœ¨ This script will install your Quilibrium node as a service and start it. âœ¨"
echo "Made with â¤ï¸ by 0xOzgur.eth (edited by LaMat)"
echo "Processing... â³"
sleep 7  # Add a 7-second delay

# Step 3.1: Check if directory ~/ceremonyclient exists
if [ -d ~/ceremonyclient ]; then
    # Check if backup directory ~/backup/qnode_keys exists, if not create it
    if [ ! -d ~/backup/qnode_keys ]; then
        mkdir -p ~/backup/qnode_keys
    fi
    
    # Check if files exist, then backup
    if [ -f ~/ceremonyclient/node/.config/keys.yml ]; then
        cp ~/ceremonyclient/node/.config/keys.yml ~/backup/qnode_keys/
        echo "âœ… Backup of keys.yml created in ~/backup/qnode_keys folder"
    fi
    
    if [ -f ~/ceremonyclient/node/.config/config.yml ]; then
        cp ~/ceremonyclient/node/.config/config.yml ~/backup/qnode_keys/
        echo "âœ… Backup of config.yml created in ~/backup/qnode_keys folder"
    fi
    
    # Remove existing directory ~/ceremonyclient
    echo "ðŸ—‘ï¸ Removing existing directory ~/ceremonyclient..."
    rm -rf ~/ceremonyclient
fi

# Step 4: Download Ceremonyclient
echo "â³ Downloading Ceremonyclient..."
sleep 1  # Add a 1-second delay
cd ~
git clone https://github.com/QuilibriumNetwork/ceremonyclient.git
cd ~/ceremonyclient/
git checkout release

# Step 9: Build Ceremonyclient qClient
#echo "â³ Building qCiient"
#sleep 1  # Add a 1-second delay
#cd ~/ceremonyclient/client
#GOEXPERIMENT=arenas go build -o qclient main.go

# Get the system architecture
ARCH=$(uname -m)

# Step10.1:Determine the ExecStart line based on the architecture
if [ "$ARCH" = "x86_64" ]; then
    EXEC_START="/root/ceremonyclient/node/node-1.4.18-linux-amd64"
elif [ "$ARCH" = "aarch64" ]; then
    EXEC_START="/root/ceremonyclient/node/node-1.4.18-linux-arm64"
elif [ "$ARCH" = "arm64" ]; then
    EXEC_START="/root/ceremonyclient/node/node-1.4.18-darwin-arm64"
else
    echo "Unsupported architecture: $ARCH"
    exit 1
fi

# Step10.2:Create Ceremonyclient Service
echo "â³ Re-Creating Ceremonyclient Service"
sleep 2  # Add a 2-second delay

# Check if the file exists before attempting to remove it
if [ -f "/lib/systemd/system/ceremonyclient.service" ]; then
    # If the file exists, remove it
    rm /lib/systemd/system/ceremonyclient.service
    echo "ceremonyclient.service file removed."
else
    # If the file does not exist, inform the user
    echo "ceremonyclient.service file does not exist. No action taken."
fi

sudo tee /lib/systemd/system/ceremonyclient.service > /dev/null <<EOF
[Unit]
Description=Ceremony Client Go App Service

[Service]
Type=simple
Restart=always
RestartSec=5s
WorkingDirectory=/root/ceremonyclient/node
ExecStart=$EXEC_START

[Install]
WantedBy=multi-user.target
EOF

# Step 8: Start the ceremonyclient service
echo "âœ… Starting Ceremonyclient Service"
sleep 2  # Add a 2-second delay
systemctl enable ceremonyclient
service ceremonyclient start

# Step 9: Final messages
echo "ðŸŽ‰ Now your node is starting!"
echo "ðŸ•’ Let it run for at least 30 minutes to generate your keys."
echo ""
echo "ðŸ” You can logout of your server if you want and login again later."
echo "ðŸ”’ After 30 minutes, backup your keys.yml and config.yml files."
echo "â„¹ï¸ More info about this in the online guide: https://iri.quest/quilibrium-node-guide"
echo ""
echo "ðŸ“œ Now I will show the node log below..."
echo "To exit the log, just type CTRL +C."

# Step 10: See the logs of the ceremonyclient service
sleep 5  # Add a 5-second delay
sudo journalctl -u ceremonyclient.service -f --no-hostname -o cat
